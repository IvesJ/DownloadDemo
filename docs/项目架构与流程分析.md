# DownloadDemo 项目架构与流程分析

## 项目概述

这是一个 Android 下载管理应用，采用 Clean Architecture 分层架构，支持断点续传、MD5校验、增量更新等功能。

---

## 项目结构

```
D:\Code\Demo\DownLoadDemo\app\src\main\java\com\ace\downloaddemo\
├── data/                    # 数据层（Repository实现、Room数据库、模型）
│   ├── local/              # Room本地存储
│   ├── model/              # 数据模型
│   ├── parser/             # JSON解析
│   └── repository/         # Repository实现
├── domain/                 # 领域层（业务逻辑、Repository接口）
│   ├── model/              # 领域模型
│   └── repository/         # Repository接口定义
├── core/                   # 核心层（下载、校验、存储等）
│   ├── download/           # 下载核心逻辑
│   ├── storage/            # 文件存储管理
│   └── validation/         # MD5校验
├── ui/                     # UI层（Activity、ViewModel、Adapter）
├── di/                     # Hilt依赖注入模块
├── service/                # 后台服务
└── receiver/               # 广播接收器
```

---

## 架构分层图

```
┌─────────────────────────────────────────────────────────────────┐
│                        UI Layer (ui)                            │
│   MainActivity → DownloadViewModel → FeatureListAdapter         │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                     Domain Layer (domain)                        │
│              FeatureDownloadManager (协调下载流程)                │
│         DownloadRepository IF │ FeatureDownloadState             │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                      Data Layer (data)                           │
│    DownloadRepositoryImpl │ Room DB │ ConfigParser               │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                      Core Layer (core)                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐    │
│  │   Download   │  │  Storage     │  │     Validation       │    │
│  │   Worker     │  │  FileManager │  │     MD5Validator     │    │
│  │ FileDownloader│  │ CleanupMgr   │  │                      │    │
│  └──────────────┘  └──────────────┘  └──────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 关键类关系图

```
DownloadViewModel
    │
    ├──► FeatureDownloadManager
    │         │
    │         ├──► DownloadWorker
    │         │         │
    │         │         └──► FileDownloader ──► FileDownloaderImpl
    │         │                                     │
    │         │                                     └──► OkHttp
    │         │
    │         ├──► FileManager
    │         │         │
    │         │         └──► MD5Validator
    │         │
    │         └──► DownloadRepository
    │                   │
    └──► FileCleanupManager
              │
              ├──► FileManager
              │
              └──► ConfigParser
```

---

## 核心模块说明

### 1. 下载模块 (core/download)

| 文件 | 作用 | 关键方法 |
|------|------|----------|
| `FileDownloader.kt` | 下载接口 | `download()`, `pause()`, `cancel()` |
| `FileDownloaderImpl.kt` | 核心下载实现 | 断点续传、OkHttp下载、模拟模式 |
| `DownloadWorker.kt` | 下载工作器 | Semaphore并发控制(最多3个) |
| `DownloadTask.kt` | 下载任务数据类 | url, savePath, md5, 进度回调 |
| `DownloadResult.kt` | 下载结果密封类 | Success/Failed/Canceled |

### 2. 校验模块 (core/validation)

| 文件 | 作用 | 关键方法 |
|------|------|----------|
| `MD5Validator.kt` | MD5校验 | `validate()`, `calculateMD5()`, 缓存支持 |

### 3. 存储管理模块 (core/storage)

| 文件 | 作用 | 关键方法 |
|------|------|----------|
| `FileManager.kt` | 文件管理器 | `getDownloadDir()`, `checkFileExistsAndValid()`, `deleteFile()`, `hasEnoughSpace()` |
| `FileCleanupManager.kt` | 清理管理器 | `scanAndCleanUnusedFiles()`, `cleanTempFiles()` |

### 4. 领域层 (domain)

| 文件 | 作用 | 关键方法 |
|------|------|----------|
| `FeatureDownloadManager.kt` | Feature下载管理器 | `downloadFeature()`, `retryFeature()`, `cancelFeature()`, `checkForUpdates()`, `updateFeature()` |
| `DownloadRepository.kt` | Repository接口 | - |
| `FeatureDownloadState.kt` | 下载状态 | Idle/Downloading/Completed/Failed/Canceled |

---

## 流程图一：核心下载流程 (FileDownloaderImpl)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        核心下载流程 (FileDownloaderImpl)                  │
└─────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────┐
                              │  开始下载   │
                              └──────┬──────┘
                                     │
                                     ▼
                         ┌─────────────────────┐
                         │ 检查是否已取消?     │
                         │ canceledUrls.contains│
                         └──────────┬──────────┘
                                    │
              ┌─────────────────────┴─────────────────────┐
              │ YES                                         │ NO
              ▼                                             ▼
      ┌───────────────┐                            ┌──────────────┐
      │  Canceled     │                            │ 模拟下载模式? │
      │ 返回Canceled  │                            │ MOCK_MODE    │
      └───────────────┘                            └──────┬───────┘
                                                          │
                                ┌──────────────────────────┴──────────────────────────┐
                                │ YES                                                   │ NO
                                ▼                                                       ▼
                    ┌─────────────────────┐                               ┌─────────────────────┐
                    │ mockDownload()      │                               │ 创建文件对象        │
                    │ (模拟下载过程)       │                               │ file + tempFile     │
                    └──────────┬──────────┘                               └──────────┬──────────┘
                               │                                                     │
                               │                                                     ▼
                               │                                         ┌─────────────────────┐
                               │                                         │ 临时文件存在?       │
                               │                                         │ tempFile.exists()   │
                               │                                         └──────────┬──────────┘
                               │                                                    │
                               │                     ┌───────────────────────────────┴──────────────┐
                               │                     │ YES (断点续传)                           │ NO
                               │                     ▼                                          ▼
                               │         ┌─────────────────────┐                    ┌─────────────────────┐
                               │         │ 获取已下载大小      │                    │ downloaded = 0     │
                               │         │ downloaded = len    │                    └──────────┬──────────┘
                               │         └──────────┬──────────┘                               │
                               │                    │                                          │
                               │                    ▼                                          │
                               │         ┌─────────────────────┐                               │
                               │         │ 构建HTTP请求        │                               │
                               │         │ 添加Range头         │                               │
                               │         │ Range: bytes=n-    │                               │
                               │         └──────────┬──────────┘                               │
                               │                    │                                          │
                               │                    ▼                                          │
                               │         ┌─────────────────────┐                               │
                               │         │ OkHttp执行请求      │                               │
                               │         │ okHttpClient.execute│                               │
                               │         └──────────┬──────────┘                               │
                               │                    │                                          │
                               │                    ▼                                          │
                               │         ┌─────────────────────┐                               │
                               │         │ 响应成功?           │                               │
                               │         │ response.isSuccessful│                               │
                               │         └──────────┬──────────┘                               │
                               │                    │                                          │
                               │     ┌──────────────┴──────────────┐                          │
                               │     │ NO                            │ YES                     │
                               │     ▼                              ▼                         │
                               │  ┌──────────────┐           ┌─────────────────────┐           │
                               │  │ Failed       │           │ 获取Content-Length  │           │
                               │  │ 返回错误     │           │ 计算总大小totalSize │           │
                               │  └──────────────┘           └──────────┬──────────┘           │
                               │                                     │                        │
                               │                                     ▼                        │
                               │                         ┌─────────────────────┐               │
                               │                         │ 打开输入流          │               │
                               │                         │ response.body.stream│               │
                               │                         └──────────┬──────────┘               │
                               │                                    │                          │
                               │                                    ▼                          │
                               │                         ┌─────────────────────┐               │
                               │                         │ 循环读取文件块      │               │
                               │                         │ buffer=8192B        │               │
                               │                         └──────────┬──────────┘               │
                               │                                    │                          │
                               │                     ┌───────────────┴───────────────┐          │
                               │                     │ 检查取消/写入文件/回调进度   │          │
                               │                     └──────────┬───────────────────┘          │
                               │                                │                              │
                               │                    ┌────────────┴────────────┐                 │
                               │                    │ EOF?                    │                 │
                               │                    └───────────┬────────────┘                 │
                               │                            │   │                             │
                               │                           END │                             │
                               │                            │   │                             │
                               │                            ▼   ▼                             │
                               │         ┌────────────────────────────────┐                   │
                               │         │ 下载完成 → 重命名临时文件      │                   │
                               │         │ tempFile.renameTo(file)       │                   │
                               │         └──────────┬─────────────────────┘                   │
                               │                    │                                          │
                               │                    ▼                                          │
                               │         ┌─────────────────────┐                              │
                               │         │ 返回Success         │                              │
                               │         │ DownloadResult      │                              │
                               │         └─────────────────────┘                              │
                               │                                                               │
                               └───────────────────────────────────────────────────────────────┘
```

---

## 流程图二：上层服务完整下载业务

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   上层服务完整下载业务流程                                       │
│                 (FeatureDownloadManager + 检验 + 删除)                         │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │ 用户触发下载    │
                              │ downloadFeature │
                              └───────┬─────────┘
                                      │
                                      ▼
                    ┌───────────────────────────────────┐
                    │ 磁盘空间检查                       │
                    │ hasEnoughSpace(estimatedSize)     │
                    │ 预留100MB余量                      │
                    └───────────┬───────────────────────┘
                                │
              ┌─────────────────┴─────────────────┐
              │ 空间不足                               │ 空间充足
              ▼                                       ▼
    ┌─────────────────┐                 ┌─────────────────────────┐
    │ Failed          │                 │ 更新状态: Downloading   │
    │ 状态=Failed     │                 │ progress=0, currentFile=│
    │ 返回            │                 └───────────┬─────────────┘
    └─────────────────┘                             │
                                                    ▼
                                    ┌─────────────────────────────┐
                                    │ 遍历所有FileInfo文件        │
                                    │ for (file in files)         │
                                    └─────────────┬───────────────┘
                                                  │
                                                  ▼
                                    ┌─────────────────────────────┐
                                    │ 检查文件是否存在且MD5有效   │
                                    │ checkFileExistsAndValid()   │
                                    │                             │
                                    │ 内部调用:                   │
                                    │ 1. 检查文件存在             │
                                    │ 2. MD5Validator.validate()  │
                                    └─────────────┬───────────────┘
                                                  │
                                  ┌───────────────┴───────────────┐
                                  │ 文件有效                       │ 文件无效/不存在
                                  ▼                               ▼
                        ┌─────────────────┐           ┌─────────────────────────┐
                        │ completedFiles++│           │ 创建DownloadTask        │
                        │ 跳过下载        │           │ url, savePath, md5      │
                        │ continue        │           └───────────┬─────────────┘
                        └─────────────────┘                       │
                                                                ▼
                                                ┌─────────────────────────────┐
                                                │ 调用DownloadWorker          │
                                                │ downloadFile(task)          │
                                                │                             │
                                                │ Semaphore并发控制(最多3个)   │
                                                └─────────────┬───────────────┘
                                                              │
                                                              ▼
                                                ┌─────────────────────────────┐
                                                │ FileDownloader.download()   │
                                                │ 执行实际下载                │
                                                └─────────────┬───────────────┘
                                                              │
                                                              ▼
                                                ┌─────────────────────────────┐
                                                │ 下载结果处理                │
                                                │ DownloadResult              │
                                                └─────────────┬───────────────┘
                                                              │
                              ┌───────────────────────────────┼───────────────────────────────┐
                              │ Success                       │ Failed                        │ Canceled
                              ▼                               ▼                               ▼
              ┌─────────────────────────┐   ┌─────────────────────────┐   ┌─────────────────────────┐
              │ MD5校验                 │   │ 更新状态: Failed        │   │ 更新状态: Canceled      │
              │ md5Validator.validate() │   │ 返回错误信息            │   │ 返回                   │
              └───────────┬─────────────┘   └─────────────────────────┘   └─────────────────────────┘
                          │
              ┌───────────┴───────────────┐
              │ 校验通过                   │ 校验失败
              ▼                           ▼
    ┌─────────────────────────┐   ┌─────────────────────────┐
    │ completedFiles++        │   │ 更新状态: Failed        │
    │ 继续下一个文件          │   │ MD5校验失败             │
    └───────────┬─────────────┘   │ 返回                   │
                │                 └─────────────────────────┘
                ▼
    ┌─────────────────────────────────────┐
    │ 所有文件处理完成?                    │
    │ completedFiles == totalFiles        │
    └───────────┬─────────────────────────┘
                │
                ▼
    ┌─────────────────────────┐
    │ 更新状态: Completed     │
    │ 返回成功                │
    └─────────────────────────┘
```

---

## MD5 校验流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        MD5 校验流程                              │
└─────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────┐
                    │ 开始校验文件MD5         │
                    │ validate(file, md5)    │
                    └───────────┬─────────────┘
                                │
              ┌─────────────────┴─────────────────┐
              │ expectedMd5为空?                  │
              │ (跳过校验)                        │
              ▼                                   ▼
    ┌─────────────────────────┐         ┌─────────────────────────┐
    │ 返回true                │         │ 检查缓存                │
    │ 校验通过                │         │ md5Cache[path]         │
    └─────────────────────────┘         └───────────┬─────────────┘
                                                    │
                                  ┌─────────────────┴─────────────────┐
                                  │ 缓存命中                            │ 缓存未命中
                                  ▼                                     ▼
                        ┌─────────────────────────┐         ┌─────────────────────────┐
                        │ 比较缓存MD5             │         │ 计算文件MD5             │
                        │ equals(expectedMd5)    │         │ calculateMD5(file)     │
                        └───────────┬─────────────┘         │ 8KB buffer分块读取      │
                                    │                       │ MessageDigest MD5       │
                                    ▼                       └───────────┬─────────────┘
                        ┌─────────────────────────┐                   │
                        │ 匹配?                   │                   ▼
                        └───────────┬─────────────┘         ┌─────────────────────────┐
                                    │                       │ 存入缓存                │
                                    ▼                       │ md5Cache[path]=result   │
                        ┌─────────────────────────┐         └───────────┬─────────────┘
                        │ 返回比较结果            │                         │
                        │ true/false              │                         ▼
                        └─────────────────────────┘         ┌─────────────────────────┐
                                                            │ 比较计算MD5             │
                                                            │ equals(expectedMd5)     │
                                                            └───────────┬─────────────┘
                                                                        │
                                                                        ▼
                                                            ┌─────────────────────────┐
                                                            │ 返回校验结果            │
                                                            │ true/false              │
                                                            └─────────────────────────┘
```

---

## 文件清理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      文件清理流程                                 │
└─────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────┐
                    │ 扫描清理孤儿文件        │
                    │ scanAndCleanUnusedFiles│
                    └───────────┬─────────────┘
                                │
                                ▼
                    ┌─────────────────────────┐
                    │ 1. 获取配置中所有文件名 │
                    │ getAllRequiredFiles()   │
                    └───────────┬─────────────┘
                                │
                                ▼
                    ┌─────────────────────────┐
                    │ 2. 获取本地所有文件     │
                    │ downloadDir.listFiles() │
                    └───────────┬─────────────┘
                                │
                                ▼
                    ┌─────────────────────────┐
                    │ 3. 找出不再需要的文件   │
                    │ localFiles - required   │
                    │ (排除.downloading)      │
                    └───────────┬─────────────┘
                                │
                                ▼
                    ┌─────────────────────────┐
                    │ 4. 删除每个孤儿文件     │
                    │ file.delete()           │
                    └───────────┬─────────────┘
                                │
                                ▼
                    ┌─────────────────────────┐
                    │ 5. 返回清理结果         │
                    │ CleanupResult           │
                    │ - deletedCount          │
                    │ - freedSpaceBytes       │
                    └─────────────────────────┘
```

---

## 核心特性总结

| 特性 | 实现方式 |
|------|----------|
| **断点续传** | 临时文件(`.downloading`) + HTTP Range头 |
| **并发控制** | Semaphore限制最多3个同时下载 |
| **MD5校验** | 下载后校验，支持缓存避免重复计算 |
| **增量更新** | 检查文件MD5，只下载有变化的文件 |
| **空间管理** | 下载前检查空间，预留100MB余量 |
| **自动清理** | 扫描并删除配置中不再需要的文件 |

---

## 关键文件位置速查

| 模块 | 文件路径 | 关键行号 |
|------|----------|----------|
| **核心下载** | `core/download/FileDownloaderImpl.kt` | 30-142 |
| **并发控制** | `core/download/DownloadWorker.kt` | 18-30 |
| **MD5校验** | `core/validation/MD5Validator.kt` | 25-67 |
| **文件管理** | `core/storage/FileManager.kt` | 61-80 |
| **清理** | `core/storage/FileCleanupManager.kt` | 30-89 |
| **业务层** | `domain/FeatureDownloadManager.kt` | 45-178 |
| **UI** | `ui/DownloadViewModel.kt` | 115-127 |

---

## 数据流总结

```
用户点击下载
     │
     ▼
MainActivity.downloadFeature()
     │
     ▼
DownloadViewModel.downloadFeature()
     │
     ▼
FeatureDownloadManager.downloadFeature()
     │
     ├─► 磁盘空间检查 ──空间不足──► Failed
     │
     ├─► 文件逐个下载循环
     │     │
     │     ├─► FileManager.checkFileExistsAndValid()
     │     │       │
     │     │       └─► MD5Validator.validate()
     │     │               │
     │     │               └─► 已存在且MD5匹配？──是──► 跳过下载
     │     │
     │     └─► 不存在或MD5不匹配 ──► DownloadWorker.downloadFile()
     │                                   │
     │                                   └─► FileDownloaderImpl.download()
     │                                              │
     │                                              ├─► OkHttp下载
     │                                              ├─► 断点续传支持
     │                                              ├─► 进度回调
     │                                              │
     │                                               └─► 下载完成
     │                                                         │
     │                                                         ▼
     │                                              MD5Validator.validate()
     │                                                         │
     │                                                         ├─► 校验通过
     │                                                         └─► 校验失败──► Failed
     │
     └─► 所有文件完成 ──► Completed
```
